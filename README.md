# Настраиваем бэкапы

## Цели домашнего задани

Научиться использовать инструмент для резервного копирования

## Описание домашнего задания

- Настроить стенд Vagrant с двумя виртуальными машинами: backup_server и client.
- Настроить удаленный бэкап каталога /etc c сервера client при помощи borgbackup.

Резервные копии должны соответствовать следующим критериям:

- директория для резервных копий /var/backup. Это должна быть отдельная точка монтирования. В данном случае для демонстрации размер не принципиален, достаточно будет и 2GB;
- репозиторий для резервных копий должен быть зашифрован ключом или паролем - на ваше усмотрение;
- имя бэкапа должно содержать информацию о времени снятия бекапа;
- глубина бекапа должна быть год, хранить можно по последней копии на конец месяца, кроме последних трех. Последние три месяца должны содержать копии на каждый день. Т.е. должна
- быть правильно настроена политика удаления старых бэкапов;
- резервная копия снимается каждые 5 минут. Такой частый запуск в целях демонстрации;
- написан скрипт для снятия резервных копий. Скрипт запускается из соответствующей Cron джобы, либо systemd timer-а - на ваше усмотрение;
- настроено логирование процесса бекапа. Для упрощения можно весь вывод перенаправлять в logger с соответствующим тегом. Если настроите не в syslog, то обязательна ротация логов.

## Пошаговая инструкция выполнения домашнего задания

- развернем стенд с помощью Vagrant и Ansible, которые подготовят для нас окружение и запустят бекап

```bash
vagrant up --no-provision
ANSIBLE_ARGS='--skip-tags="client"' vagrant provision
ANSIBLE_ARGS='--tags="client"' vagrant provision client
```

> Ключ шифрования и частоту бекапа можно задать в ./host_vars/client

- оставим стенд поработать пол часа

- зайдем на виртуалку client и посмотрим лог

```bash
vagrant ssh client
sudo -i
```

![2024-02-16_14-43-46](https://github.com/dimkaspaun/backup/assets/156161074/d674391c-d084-4cdd-9bfe-5cb25610eed5)

- последний созданный бекап

```bash
BORG_PASSPHRASE=Otus1234 borg list borg@192.168.50.11:/var/backup/
```
![2024-02-16_14-44-54](https://github.com/dimkaspaun/backup/assets/156161074/b9d2e390-78d0-4646-a492-382646194008)

- посмотрим список файлов

```bash
BORG_PASSPHRASE=Otus1234 borg list borg@192.168.50.11:/var/backup/::etc-2024-02-16_07:50:41 | head -n 10
```
![2024-02-16_14-52-16](https://github.com/dimkaspaun/backup/assets/156161074/0e4a7478-6cc5-4660-ac8a-51e6f773d8ca)


- остановим бекап

```bash
systemctl stop borg-backup.timer
```

- восстановим директорию /etc из бекапа

```bash
cd
BORG_PASSPHRASE=Otus1234 borg extract borg@192.168.50.11:/var/backup/::etc-2024-02-16_08:37:02 etc
```
![2024-02-16_15-43-14](https://github.com/dimkaspaun/backup/assets/156161074/f08d1eb9-e7fd-4583-89d1-63cfbcb28b28)
